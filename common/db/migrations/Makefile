# Goose Migration Makefile
# 
# ç”¨æ³•:
#   make goose.install          - å®‰è£… goose å·¥å…·
#   make goose.auth.status      - æŸ¥çœ‹ auth è¿ç§»çŠ¶æ€
#   make goose.auth.up          - æ‰§è¡Œ auth è¿ç§»
#   make goose.auth.down        - å›æ»š auth è¿ç§»
#   make goose.user.status      - æŸ¥çœ‹ user è¿ç§»çŠ¶æ€
#   make goose.user.up          - æ‰§è¡Œ user è¿ç§»
#   make goose.user.down        - å›æ»š user è¿ç§»

# åŠ è½½é¡¹ç›®æ ¹ç›®å½•çš„ .env æ–‡ä»¶
ifneq (,$(wildcard ../../../.env))
    include ../../../.env
    export
endif

# ä¸»åº“ç«¯å£ï¼š5433 (docker-compose.yml: 5433:5432)
# ä»åº“ç«¯å£ï¼š5434 (docker-compose.yml: 5434:5432)
DB_USER ?= ${DB_USER}
DB_PASSWORD ?= ${DB_PASSWORD}
DB_HOST ?= ${DB_HOST}
DB_PORT ?= 5433
DB_NAME ?= ${DB_NAME}

# ä¸»åº“ DSN è¿æ¥å­—ç¬¦ä¸²
PG_MASTER_DSN = postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable

# è¿ç§»ç›®å½•ï¼ˆç›¸å¯¹äºå½“å‰ Makefile çš„ä½ç½®ï¼‰
MIGRATIONS_DIR = .

# ==== goose å®‰è£… ====
.PHONY: goose.install
goose.install:
	@echo "ğŸ“¦ Installing goose..."
	go install github.com/pressly/goose/v3/cmd/goose@latest
	@echo "âœ… Goose installed successfully"

# ==== goose ç‰ˆæœ¬æ£€æŸ¥ ====
.PHONY: goose.version
goose.version:
	@goose -version || echo "âš ï¸  Goose not installed. Run 'make goose.install' first."

# ==== AUTH è¿ç§»ï¼ˆåªå¯¹ä¸»åº“ï¼‰ ====
.PHONY: goose.auth.status
goose.auth.status:
	@echo "ğŸ“Š Checking auth migration status..."
	@goose -dir $(MIGRATIONS_DIR)/auth postgres "$(PG_MASTER_DSN)" status

.PHONY: goose.auth.up
goose.auth.up:
	@echo "â¬†ï¸  Running auth migrations up..."
	@goose -dir $(MIGRATIONS_DIR)/auth postgres "$(PG_MASTER_DSN)" up
	@echo "âœ… Auth migrations completed"

.PHONY: goose.auth.down
goose.auth.down:
	@echo "â¬‡ï¸  Rolling back auth migration..."
	@goose -dir $(MIGRATIONS_DIR)/auth postgres "$(PG_MASTER_DSN)" down
	@echo "âœ… Auth migration rolled back"

.PHONY: goose.auth.reset
goose.auth.reset:
	@echo "ğŸ”„ Resetting auth migrations..."
	@goose -dir $(MIGRATIONS_DIR)/auth postgres "$(PG_MASTER_DSN)" reset
	@echo "âœ… Auth migrations reset"

# ==== USER è¿ç§»ï¼ˆåªå¯¹ä¸»åº“ï¼‰ ====
.PHONY: goose.user.status
goose.user.status:
	@echo "ğŸ“Š Checking user migration status..."
	@goose -dir $(MIGRATIONS_DIR)/user postgres "$(PG_MASTER_DSN)" status

.PHONY: goose.user.up
goose.user.up:
	@echo "â¬†ï¸  Running user migrations up..."
	@goose -dir $(MIGRATIONS_DIR)/user postgres "$(PG_MASTER_DSN)" up
	@echo "âœ… User migrations completed"

.PHONY: goose.user.down
goose.user.down:
	@echo "â¬‡ï¸  Rolling back user migration..."
	@goose -dir $(MIGRATIONS_DIR)/user postgres "$(PG_MASTER_DSN)" down
	@echo "âœ… User migration rolled back"

.PHONY: goose.user.reset
goose.user.reset:
	@echo "ğŸ”„ Resetting user migrations..."
	@goose -dir $(MIGRATIONS_DIR)/user postgres "$(PG_MASTER_DSN)" reset
	@echo "âœ… User migrations reset"

# ==== å…¨éƒ¨è¿ç§» ====
.PHONY: goose.up.all
goose.up.all: goose.auth.up goose.user.up
	@echo "âœ… All migrations completed"

.PHONY: goose.status.all
goose.status.all:
	@echo "=========================================="
	@echo "ğŸ“Š All Migration Status"
	@echo "=========================================="
	@echo ""
	@echo "ğŸ” AUTH Migrations:"
	@make --no-print-directory goose.auth.status
	@echo ""
	@echo "ğŸ‘¤ USER Migrations:"
	@make --no-print-directory goose.user.status
	@echo ""
	@echo "=========================================="

# ==== å¸®åŠ©ä¿¡æ¯ ====
.PHONY: help
help:
	@echo "ğŸ—„ï¸  Goose Migration Commands"
	@echo ""
	@echo "Installation:"
	@echo "  make goose.install          - Install goose tool"
	@echo "  make goose.version          - Check goose version"
	@echo ""
	@echo "Auth Migrations:"
	@echo "  make goose.auth.status      - Check auth migration status"
	@echo "  make goose.auth.up          - Run auth migrations"
	@echo "  make goose.auth.down        - Rollback auth migration"
	@echo "  make goose.auth.reset       - Reset all auth migrations"
	@echo ""
	@echo "User Migrations:"
	@echo "  make goose.user.status      - Check user migration status"
	@echo "  make goose.user.up          - Run user migrations"
	@echo "  make goose.user.down        - Rollback user migration"
	@echo "  make goose.user.reset       - Reset all user migrations"
	@echo ""
	@echo "Batch Operations:"
	@echo "  make goose.up.all           - Run all migrations"
	@echo "  make goose.status.all       - Check all migration status"
	@echo ""
	@echo "Configuration:"
	@echo "  PG_MASTER_DSN: $(PG_MASTER_DSN)"
	@echo ""

.DEFAULT_GOAL := help

